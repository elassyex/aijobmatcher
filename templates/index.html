{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Role Matcher - Complete Django Project</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .skill-tag {
            transition: all 0.3s ease;
        }
        .skill-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .analysis-result {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        .analysis-result.show {
            opacity: 1;
            transform: translateY(0);
        }
        .progress-bar {
            transition: width 1s ease-in-out;
        }
        .loading-spinner {
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Dark theme overrides */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; color: #000000; }
        .dark .text-gray-800 { color: #0c0c0c; }
        .dark .text-gray-700 { color: #edf2f7; }
        .dark .bg-gray-50 { background-color: #2d3748; }
        .dark header.gradient-bg { background: linear-gradient(135deg, #3b4094 0%, #5d2cce 100%); }
        .dark footer { background-color: #0f0f0f; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen transition-colors duration-500">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg flex justify-between items-center px-6">
        <div class="flex items-center">
            <i class="fas fa-brain text-3xl mr-3"></i>
            <h1 class="text-3xl font-bold">AI Job Role Matcher</h1>
        </div>
        <!-- Theme toggle button -->
        <button id="themeToggle" class="bg-white text-purple-600 px-4 py-2 rounded-md shadow hover:bg-gray-100 transition duration-300">
            <i class="fas fa-moon"></i> Dark Mode
        </button>
    </header>

    <!-- Main Application -->
    <main class="container mx-auto px-4 py-8">
        <!-- Job Matcher Interface -->
        <div class="bg-white rounded-lg shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">
                <i class="fas fa-target mr-2 text-purple-600"></i>
                Job Role Analysis
            </h2>

            <!-- Existing UI -->
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Left Side (Form) -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-briefcase mr-2"></i>Desired Job Role
                        </label>
                        <input id="jobRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Software Engineer">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-cogs mr-2"></i>Your Skills
                        </label>
                        <input type="text" id="skillInput" placeholder="Type a skill and press Enter..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <div id="skillTags" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2"></i>Years of Experience
                        </label>
                        <select id="experience" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="0-1">0-1 years</option>
                            <option value="1-3">1-3 years</option>
                            <option value="3-5">3-5 years</option>
                            <option value="5-7">5-7 years</option>
                            <option value="7+">7+ years</option>
                        </select>
                    </div>

                    <button id="analyzeBtn" class="w-full bg-purple-600 text-white py-3 px-6 rounded-md hover:bg-purple-700 transition duration-300 font-semibold">
                        <i class="fas fa-robot mr-2"></i>Analyze with AI
                    </button>
                </div>

                <!-- Right Side (Results) -->
                <div id="resultsPanel" class="analysis-result">
                    <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-chart-line mr-2 text-purple-600"></i>Analysis Results
                        </h3>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="hidden text-center py-8">
                            <div class="loading-spinner border-4 border-gray-200 border-t-4 rounded-full w-12 h-12 mx-auto mb-4"></div>
                            <p class="text-gray-600">AI is analyzing your profile...</p>
                        </div>

                        <!-- Results Content -->
                        <div id="resultsContent" class="hidden space-y-6">
                            <!-- Match Score -->
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-gray-700">Overall Match</span>
                                    <span id="matchScore" class="text-2xl font-bold text-purple-600">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="matchProgressBar" class="progress-bar bg-purple-600 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Skills Breakdown Chart -->
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">Skills Analysis</h4>
                                <div style="height: 300px;">
                                    <canvas id="skillsChart"></canvas>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div id="recommendations" class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Recommendations
                                </h4>
                                <div id="recommendationsList"></div>
                            </div>

                            <!-- Missing Skills -->
                            <div id="missingSkills" class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-plus-circle mr-2 text-green-500"></i>Skills to Develop
                                </h4>
                                <div id="missingSkillsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 text-center">
        <p>&copy; AI Job Role Matcher. Built by Mohamed Elassy.</p>
    </footer>

    <!-- Scripts -->
    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            themeToggle.innerHTML = isDark 
                ? '<i class="fas fa-sun" class="text-white"></i> Light Mode'
                : '<i class="fas fa-moon"></i> Dark Mode';
        });
    </script>
    <script>

        let userSkills = [];
        let skillsChart = null;

        // DOM Elements
        const skillInput = document.getElementById('skillInput');
        const skillTags = document.getElementById('skillTags');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsPanel = document.getElementById('resultsPanel');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsContent = document.getElementById('resultsContent');

        // Event Listeners
        skillInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addSkill(this.value.trim());
                this.value = '';
            }
        });

        analyzeBtn.addEventListener('click', analyzeJobMatch);

        function addSkill(skill) {
            if (skill && !userSkills.includes(skill.toLowerCase())) {
                userSkills.push(skill.toLowerCase());
                renderSkillTags();
            }
        }

        function removeSkill(skill) {
            userSkills = userSkills.filter(s => s !== skill);
            renderSkillTags();
        }

        function renderSkillTags() {
            skillTags.innerHTML = '';
            userSkills.forEach(skill => {
                const tag = document.createElement('span');
                tag.className = 'skill-tag inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium';
                tag.innerHTML = `
                    ${skill}
                    <button onclick="removeSkill('${skill}')" class="ml-2 text-purple-600 hover:text-purple-800">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                skillTags.appendChild(tag);
            });
        }

        async function analyzeJobMatch() {
            const jobRole = document.getElementById('jobRole').value;
            const experience = document.getElementById('experience').value;

            if (!jobRole) {
                alert('Please select a job role');
                return;
            }
            if (userSkills.length === 0) {
                alert('Please add at least one skill');
                return;
            }

            // Show loading UI
            resultsPanel.classList.add('show');
            loadingSpinner.classList.remove('hidden');
            resultsContent.classList.add('hidden');

            try {
                const resp = await fetch('/analyze/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        skills: userSkills,          // already normalized in your UI
                        job_role: jobRole,           // any job title works; LLM infers skills
                        experience: experience       // used as bonus on the backend
                    })
                });

                const data = await resp.json();

                if (!data.success) {
                    throw new Error(data.error || 'Analysis failed');
                }

                // Render the AI result using your existing renderer
                displayResults(data.result);

            } catch (err) {
                console.error(err);
                alert('Error analyzing with AI: ' + err.message);
            } finally {
                // Reveal results area
                loadingSpinner.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            }
        }


        function generateRecommendations(matchScore, missingCore, missingPreferred) {
            const recommendations = [];

            if (matchScore >= 80) {
                recommendations.push("🎉 Excellent match! You're ready to apply for this role.");
                recommendations.push("💡 Consider preparing for technical interviews focusing on your strongest skills.");
            } else if (matchScore >= 60) {
                recommendations.push("👍 Good match! Focus on developing a few key skills to improve your profile.");
                recommendations.push("📚 Consider taking online courses or building projects with missing skills.");
            } else {
                recommendations.push("📈 Consider developing more core skills before applying to increase your chances.");
                recommendations.push("🎯 Focus on the most important missing core skills first.");
            }

            if (missingCore.length > 0) {
                recommendations.push(`🔥 Priority skills to learn: ${missingCore.slice(0, 3).join(', ')}`);
            }

            if (missingPreferred.length > 0 && matchScore > 70) {
                recommendations.push(`⭐ Nice-to-have skills: ${missingPreferred.slice(0, 2).join(', ')}`);
            }

            return recommendations;
        }

        function displayResults(analysis) {
            // Update match score
            document.getElementById('matchScore').textContent = analysis.match_percentage + '%';
            document.getElementById('matchProgressBar').style.width = analysis.match_percentage + '%';

            // Set progress bar color based on score
            const progressBar = document.getElementById('matchProgressBar');
            if (analysis.match_percentage >= 80) {
                progressBar.className = 'progress-bar bg-green-500 h-3 rounded-full';
            } else if (analysis.match_percentage >= 60) {
                progressBar.className = 'progress-bar bg-yellow-500 h-3 rounded-full';
            } else {
                progressBar.className = 'progress-bar bg-red-500 h-3 rounded-full';
            }

            // Create skills breakdown chart
            createSkillsChart(analysis.skill_breakdown);

            // Display recommendations
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            analysis.recommendations.forEach(rec => {
                const li = document.createElement('div');
                li.className = 'mb-2 p-2 bg-gray-50 rounded text-sm';
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });

            // Display missing skills
            const missingSkillsList = document.getElementById('missingSkillsList');
            missingSkillsList.innerHTML = '';
            
            if (analysis.missing_core_skills.length > 0) {
                const coreTitle = document.createElement('h5');
                coreTitle.className = 'font-semibold text-red-600 mb-2';
                coreTitle.textContent = 'Core Skills:';
                missingSkillsList.appendChild(coreTitle);
                
                analysis.missing_core_skills.forEach(skill => {
                    const skillTag = document.createElement('span');
                    skillTag.className = 'inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs mr-2 mb-2';
                    skillTag.textContent = skill;
                    missingSkillsList.appendChild(skillTag);
                });
            }

            if (analysis.missing_preferred_skills.length > 0) {
                const preferredTitle = document.createElement('h5');
                preferredTitle.className = 'font-semibold text-green-600 mb-2 mt-4';
                preferredTitle.textContent = 'Preferred Skills:';
                missingSkillsList.appendChild(preferredTitle);
                
                analysis.missing_preferred_skills.forEach(skill => {
                    const skillTag = document.createElement('span');
                    skillTag.className = 'inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs mr-2 mb-2';
                    skillTag.textContent = skill;
                    missingSkillsList.appendChild(skillTag);
                });
            }
        }

        function createSkillsChart(skillBreakdown) {
            const ctx = document.getElementById('skillsChart').getContext('2d');
            
            if (skillsChart) {
                skillsChart.destroy();
            }

            skillsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(skillBreakdown),
                    datasets: [{
                        data: Object.values(skillBreakdown),
                        backgroundColor: [
                            '#8B5CF6',
                            '#06B6D4',
                            '#10B981'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        setTimeout(() => {
            const sampleSkills = ['Python', 'JavaScript', 'Git'];
            sampleSkills.forEach(skill => addSkill(skill));
        }, 1000);
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"97783630bdb9c0ab","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.8.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
